generator client {
  provider = "prisma-client-js"
  // Prisma ORM 7 requires an explicit output path. Keeping this in node_modules
  // preserves existing `@prisma/client` imports and current deploy packaging.
  output   = "../node_modules/.prisma/client"
  previewFeatures =["views"]
}

datasource db {
  provider = "postgresql"
}

model Todos {
  id          Int       @id @default(autoincrement())
  title       String    @db.VarChar(255)
  description String?
  isCompleted Boolean?  @default(false) @map("is_completed")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  @@map("todos")
}

model User {
  id           Int           @id @default(autoincrement())
  email        String        @unique
  role         String
  tournaments  Tournament[]
  participants Participant[]

  @@map("user")
}

model Tournament {
  id           Int               @id @default(autoincrement())
  name         String
  date         DateTime
  location     String?
  organizerId  Int               @map("organizer_id")
  organizer    User              @relation(fields: [organizerId], references: [id])
  events       TournamentEvent[]
  participants Participant[]

  @@map("tournament")
}

model Event {
  id          Int               @id @default(autoincrement())
  name        String
  tournaments TournamentEvent[] @relation("EventToTournamentEvent")
  allowedDivisions EventAllowedDivision[]
  participantEvents ParticipantEvent[]
  @@map("event")
}

model Division {
  id             Int             @id @default(autoincrement())
  divisionTypeId Int             @map("division_type_id")  
  beltRankId     Int?            @map("belt_rank_id")
  beltRank       BeltRank?       @relation(fields: [beltRankId], references: [id])
  divisionType   DivisionType     @relation(fields: [divisionTypeId], references: [id])
  tournamentEventDivisions TournamentEventDivision[]
 
  @@map("division")
}

model DivisionType{
  id             Int             @id @default(autoincrement())
  name           String
  minAge         Int?            @map("min_age")
  maxAge         Int?            @map("max_age")
  divisions      Division[]
  allowedEvents EventAllowedDivision[]
  @@map("division_type")
}

model TournamentEventDivision {
  id                 Int              @id @default(autoincrement())
  tournamentEventId  Int              @map("tournament_event_id")
  tournamentEvent    TournamentEvent  @relation(fields: [tournamentEventId], references: [id])
  divisionId         Int              @map("division_id")
  division           Division         @relation(fields: [divisionId], references: [id])
  genderId           Int              @map("gender_id")
  eventGender        EventGender      @relation(fields: [genderId], references: [id])
  displayName        String?          @map("display_name")
  registrations      Registration[]

  @@map("tournament_event_division")
}

model Participant {
  id            Int            @id @default(autoincrement())
  firstName     String         @map("first_name")
  lastName      String         @map("last_name")
  age           Int
  genderId Int @map("gender_id")
  gender   EventGender @relation(fields: [genderId], references: [id])
  tournamentId  Int            @map("tournament_id")
  tournament    Tournament     @relation(fields: [tournamentId], references: [id])
  userId        Int            @map("user_id")
  user          User           @relation(fields: [userId], references: [id])
  beltRankId Int    @map("belt_rank_id")
  rank          BeltRank @relation(fields: [beltRankId], references:[id])
  registrations Registration[]
  notes         String?
  paid          Boolean        @default (false)
  dojoId       Int?            @map("dojo_id")
  dojo          Dojo?           @relation(fields:[dojoId], references:[id])
  otherDojoName String?        @map("other_dojo_name") 
  checkedIn     Boolean        @map("checked_in") @default(false)
  events        ParticipantEvent[]  
  @@map("participant")
}

model Registration {
  id              Int           @id @default(autoincrement())
  participantId   Int           @map("participant_id")
  participant     Participant   @relation(fields: [participantId], references: [id])
  eventDivisionId Int           @map("event_division_id")
  tournamentEventDivision   TournamentEventDivision @relation(fields: [eventDivisionId], references: [id])

  @@map("registration")
}

model TournamentEvent {
  id           Int        @id @default(autoincrement())
  tournamentId Int        @map("tournament_id")
  tournament   Tournament @relation(fields: [tournamentId], references: [id])
  eventId      Int        @map("event_id")
  event        Event      @relation("EventToTournamentEvent", fields: [eventId], references: [id])
  bracketType  String?    @map("bracket_type")
  tournamentEventDivisions TournamentEventDivision[]
  @@map("tournament_event")
}

model BeltRank {
  id          Int        @id @default(autoincrement())
  rank        String
  beltColor   String     @map("belt_color")
  disiplineId Int        @map("disipline_id")
  disipline   Disipline  @relation(fields: [disiplineId], references: [id])
  sortOrder   Int           @map("sort_order") @default(0)
  divisions   Division[]
  participants Participant[]

  @@map("belt_rank")
}

model Disipline {
  id          Int        @id @default(autoincrement())
  description String
  beltRanks   BeltRank[]

  @@map("disipline")
}

model EventGender {
  id             Int             @id @default(autoincrement())
  description    String
  tournamentEventDivisions TournamentEventDivision[]
  participants   Participant[]  

  @@map("event_gender")
}

model EventAllowedDivision {
  id              Int       @id @default(autoincrement())
  eventId         Int       @map("event_id")
  divisionTypeId  Int       @map("division_type_id")

  event           Event         @relation(fields: [eventId], references: [id])
  divisionType    DivisionType  @relation(fields: [divisionTypeId], references: [id])

  @@unique([eventId, divisionTypeId])
  @@map("event_allowed_division")
}

model Dojo {
  id            Int       @id @default(autoincrement())
  dojoName      String    @map("dojo_name")
  city          String    
  participant Participant[]
  @@map("dojo")
}

model ParticipantEvent{
  id              Int     @id @default(autoincrement())
  participantId   Int     @map("participant_id") 
  eventId         Int     @map("event_id")
  participant     Participant @relation(fields:[participantId] , references:[id])
  event           Event @relation(fields:[eventId] , references: [id])
  @@map("participant_event")
}

view ParticipantRegistrationSummary {
  userEmail              String     @map("user_email")
  userId                 Int        @map("user_id")
  participantId          Int        @map("participant_id")  
  firstName              String     @map("first_name")
  lastName               String     @map("last_name")
  age                    Int
  beltColor              String     @map("belt_color")
  participantGender      String     @map("participant_gender")
  participantDivisionType String    @map("participant_division_type")
  paid                   Boolean
  checkedIn              Boolean    @map("checked_in")
  eventRegistered        String     @map("event_registered")
  tournamentId           Int        @map("tournament_id")
  eventId                Int        @map("event_id")
  participantEventId     Int        @map("participant_event_id")
  genderId               Int        @map("gender_id")

  
  @@map("participant_registration_summary")
}