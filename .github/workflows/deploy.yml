name: Deploy to Azure App Services

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps --force

      - name: Compute build metadata
        run: |
          VERSION=$(node -e "const n=Number(process.env.GITHUB_RUN_NUMBER||1); console.log((1 + (n-1)/10).toFixed(1))")
          echo "VITE_BUILD_VERSION=$VERSION" >> $GITHUB_ENV
          echo "VITE_BUILD_SHA=${GITHUB_SHA}" >> $GITHUB_ENV
          echo "VITE_BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      - name: Build UI
        run: npm run build
        env:
          VITE_API_URL: https://pre-reg-spike-api-gncmescydpgebuhj.canadacentral-01.azurewebsites.net
          VITE_API_KEY: ${{ secrets.VITE_API_KEY }}
          VITE_BUILD_VERSION: ${{ env.VITE_BUILD_VERSION }}
          VITE_BUILD_SHA: ${{ env.VITE_BUILD_SHA }}
          VITE_BUILD_TIME: ${{ env.VITE_BUILD_TIME }}

      - name: Write build marker
        run: |
          echo "version=${{ env.VITE_BUILD_VERSION }}" > dist/build-info.txt
          echo "sha=${{ env.VITE_BUILD_SHA }}" >> dist/build-info.txt
          echo "time=${{ env.VITE_BUILD_TIME }}" >> dist/build-info.txt

      - name: Upload UI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ui-build
          path: dist/
          retention-days: 1

  build-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      - name: Generate Prisma client
        run: npx prisma generate
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost/dummy"
      - name: Compile API
        run: npx tsc -p tsconfig.api.json --noEmit false

      - name: Upload API artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: |
            *.js
            shared/
            errors/
            validations/
            prisma/
            node_modules/
            package.json
            package-lock.json
          retention-days: 1

  deploy-ui:
    needs: build-ui
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download UI artifacts
        uses: actions/download-artifact@v4
        with:
          name: ui-build
          path: ./wwwroot

      - name: Create UI startup + static server
        run: |
          cat > ./wwwroot/startup.sh << 'EOF'
          #!/bin/bash
          set -e
          export PORT=${PORT:-${WEBSITES_PORT:-8080}}
          node /home/site/wwwroot/server.mjs
          EOF
          chmod +x ./wwwroot/startup.sh

          cat > ./wwwroot/server.mjs << 'EOF'
          import http from 'node:http'
          import fs from 'node:fs'
          import path from 'node:path'
          import { fileURLToPath } from 'node:url'

          const __filename = fileURLToPath(import.meta.url)
          const __dirname = path.dirname(__filename)
          const root = __dirname
          const port = Number(process.env.PORT || 8080)

          const mime = {
            '.html': 'text/html; charset=utf-8',
            '.js': 'text/javascript; charset=utf-8',
            '.css': 'text/css; charset=utf-8',
            '.json': 'application/json; charset=utf-8',
            '.svg': 'image/svg+xml',
            '.png': 'image/png',
            '.jpg': 'image/jpeg',
            '.jpeg': 'image/jpeg',
            '.ico': 'image/x-icon',
            '.txt': 'text/plain; charset=utf-8',
            '.map': 'application/json; charset=utf-8',
            '.woff': 'font/woff',
            '.woff2': 'font/woff2',
          }

          function sendFile(res, filePath) {
            const ext = path.extname(filePath).toLowerCase()
            res.statusCode = 200
            res.setHeader('Content-Type', mime[ext] || 'application/octet-stream')

            // Avoid stale HTML causing old hashed assets to be referenced
            if (ext === '.html') {
              res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate')
              res.setHeader('Pragma', 'no-cache')
              res.setHeader('Expires', '0')
            } else if (filePath.includes('/assets/')) {
              // Fingerprinted assets are safe to cache
              res.setHeader('Cache-Control', 'public, max-age=31536000, immutable')
            }

            fs.createReadStream(filePath).pipe(res)
          }

          const server = http.createServer((req, res) => {
            const url = new URL(req.url || '/', `http://${req.headers.host || 'localhost'}`)
            const pathname = decodeURIComponent(url.pathname)

            // Basic hardening
            if (pathname.includes('..')) {
              res.statusCode = 400
              res.end('Bad request')
              return
            }

            let filePath = path.join(root, pathname)
            if (pathname === '/' || pathname === '') {
              filePath = path.join(root, 'index.html')
            }

            fs.stat(filePath, (err, stats) => {
              if (!err && stats.isFile()) {
                sendFile(res, filePath)
                return
              }

              // SPA fallback
              const indexPath = path.join(root, 'index.html')
              fs.stat(indexPath, (indexErr, indexStats) => {
                if (!indexErr && indexStats.isFile()) {
                  sendFile(res, indexPath)
                } else {
                  res.statusCode = 404
                  res.end('Not found')
                }
              })
            })
          })

          server.listen(port, '0.0.0.0', () => {
            console.log(`Static UI server listening on ${port}`)
          })
          EOF

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ format('{{"clientId":"{0}","clientSecret":"{1}","subscriptionId":"{2}","tenantId":"{3}"}}', secrets.AZURE_CLIENT_ID, secrets.AZURE_CLIENT_SECRET, secrets.AZURE_SUBSCRIPTION_ID, secrets.AZURE_TENANT_ID) }}

      - name: Deploy UI to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: pre-reg-spike-ui
          package: ./wwwroot
          clean: true

      - name: Configure UI App Settings
        run: |
          az webapp config appsettings set \
            --resource-group pre-reg-spike-rg \
            --name pre-reg-spike-ui \
            --settings \
            VITE_API_KEY="${{ secrets.VITE_API_KEY }}" \
            VITE_API_URL="https://pre-reg-spike-api-gncmescydpgebuhj.canadacentral-01.azurewebsites.net" \
            API_SERVER="https://pre-reg-spike-api-gncmescydpgebuhj.canadacentral-01.azurewebsites.net"
          
          az webapp config set --resource-group pre-reg-spike-rg --name pre-reg-spike-ui --startup-file "bash /home/site/wwwroot/startup.sh"

  deploy-api:
    needs: build-api
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download API artifacts
        uses: actions/download-artifact@v4
        with:
          name: api-build
          path: ./api-deploy

      - name: Force API package to CommonJS
        run: |
          cat > ./api-deploy/package.json << 'EOF'
          {
            "name": "pre-reg-spike-api",
            "private": true,
            "type": "commonjs"
          }
          EOF

      - name: Create startup script
        run: |
          mkdir -p ./api-deploy
          cat > ./api-deploy/startup.sh << 'EOF'
          #!/bin/bash
          export PORT=${WEBSITES_PORT:-8080}
          cd /home/site/wwwroot
          node api-server.js
          EOF
          chmod +x ./api-deploy/startup.sh

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ format('{{"clientId":"{0}","clientSecret":"{1}","subscriptionId":"{2}","tenantId":"{3}"}}', secrets.AZURE_CLIENT_ID, secrets.AZURE_CLIENT_SECRET, secrets.AZURE_SUBSCRIPTION_ID, secrets.AZURE_TENANT_ID) }}

      - name: Deploy API to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: pre-reg-spike-api
          package: ./api-deploy

      - name: Configure API App Settings
        run: |
          az webapp config appsettings set \
            --resource-group pre-reg-spike-api_group \
            --name pre-reg-spike-api \
            --settings \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            API_KEY="${{ secrets.API_KEY }}" \
            CORS_ORIGINS="https://pre-reg-spike-ui-f3hghrcse9gme5ge.canadacentral-01.azurewebsites.net" \
            WEBSITES_PORT=8080
          
          az webapp config set \
            --resource-group pre-reg-spike-api_group \
            --name pre-reg-spike-api \
            --startup-file "bash /home/site/wwwroot/startup.sh"
